# shapes - Differentiable Shape Intersections

Rust library for computing shape intersections with automatic differentiation. Used by [apvd] for area-proportional Venn diagram generation.

[apvd]: https://github.com/runsascoded/apvd

## Workspace Structure

```
shapes/
├── apvd-core/     # Core computation library (platform-agnostic)
├── apvd-wasm/     # WASM bindings + WorkerTrainingClient for browser
│   ├── src/       # Rust WASM bindings
│   ├── pkg/       # wasm-pack output (@apvd/wasm npm package)
│   └── ts/        # @apvd/worker TypeScript package (WorkerTrainingClient)
├── apvd-cli/      # Native CLI and WebSocket server
└── client/        # @apvd/client TypeScript package (types + WebSocketTrainingClient)
```

## Build

```bash
# WASM (for browser)
cd apvd-wasm && wasm-pack build --target web   # Output: apvd-wasm/pkg/

# TypeScript packages
cd client && pnpm build                        # @apvd/client
cd apvd-wasm/ts && pnpm build                  # apvd-wasm TypeScript

# Native CLI
cargo build -p apvd-cli --release              # Output: target/release/apvd

# Tests
cargo test -p apvd-core                        # Core library tests
cargo test -p apvd-cli                         # CLI tests
```

## CLI Usage

```bash
# Batch training
apvd train -s shapes.json -t targets.json -m 1000 -p 6

# WebSocket server (for frontend)
apvd serve -p 8080
```

### Train Options
- `-s, --shapes` - Input shapes JSON (file or inline)
- `-t, --targets` - Target areas JSON
- `-m, --max-steps` - Maximum steps [default: 1000]
- `-l, --learning-rate` - Learning rate [default: 0.05]
- `-p, --parallel` - Parallel scene variants [default: 1]
- `-R, --robust` - Use Adam + gradient clipping
- `-o, --output` - Output file (default: stdout)
- `-q, --quiet` - JSON only, no progress

## Architecture

### Shape Types (`apvd-core/src/geometry/shape.rs`)
- **Circle**: center + radius
- **XYRR**: axis-aligned ellipse (center + x/y radii)
- **XYRRT**: rotated ellipse (center + x/y radii + theta)
- **Polygon**: arbitrary vertex list

### Core Modules (`apvd-core/src/`)

**Geometry** (`geometry/`):
- `circle.rs`, `polygon.rs`: Shape implementations
- `ellipses/xyrr.rs`, `xyrrt.rs`: Ellipse computations
- `ellipses/quartic.rs`: Quartic solver for ellipse-ellipse intersections
- `r2.rs`: 2D point type
- `shape.rs`: Shape enum and traits

**Analysis** (`analysis/`):
- `intersect.rs`, `intersection.rs`: Shape intersection detection
- `region.rs`, `regions.rs`: Region identification and area computation
- `scene.rs`: Full scene analysis

**Optimization** (`optimization/`):
- `model.rs`: Training loop, supports vanilla GD, Adam, robust
- `step.rs`: Single optimization step with gradient computation
- `adam.rs`: Adam optimizer state
- `robust.rs`: Robust optimizer (Adam + clipping + backtracking)
- `targets.rs`: Target region sizes with inclusive/exclusive expansion

**Math** (`math/`):
- `polynomial/`: Quadratic, cubic, quartic solvers
- `dual.rs`: Forward-mode AD wrapper around `num_dual::DualDVec64`

### TypeScript Packages

**`@apvd/client`** (`client/`):
- Core types: `TrainingClient`, `TrainingRequest`, `ProgressUpdate`, `StepState`, etc.
- `WebSocketTrainingClient`: Connects to native Rust server via WebSocket
- `createTrainingClient({ transport: "websocket", url })`: Factory function

**`@apvd/worker`** (`apvd-wasm/ts/`):
- `WorkerTrainingClient`: Runs training in Web Worker using WASM
- `createWorkerTrainingClient()`: Factory function
- Uses `import type` from `@apvd/client` for shared types

**`@apvd/wasm`** (`apvd-wasm/pkg/`):
- WASM binary + JS glue generated by wasm-pack
- Post-build `jq` renames package from `apvd-wasm` to `@apvd/wasm`

**Package Split Rationale**:
- `@apvd/client` has no WASM dependencies, can be used in Node.js or server-side rendering
- `@apvd/wasm` contains WASM binary and JS glue, browser-only
- `@apvd/worker` wraps WASM in a Web Worker for non-blocking training

**Migration for Existing Code**:
```typescript
// OLD (no longer works):
import { createTrainingClient } from "@apvd/client";
const client = createTrainingClient({ transport: "worker", wasmUrl: "..." });

// NEW (use @apvd/worker for Worker transport):
import { createWorkerTrainingClient } from "@apvd/worker";
const client = createWorkerTrainingClient();

// WebSocket transport unchanged:
import { createTrainingClient } from "@apvd/client";
const client = createTrainingClient({ transport: "websocket", url: "ws://..." });
```

### WASM Exports (`apvd-wasm/src/lib.rs`)
- `make_model(inputs, targets)`: Create optimization model
- `train(model, max_step_error_ratio, max_steps)`: Vanilla GD training
- `train_adam(model, learning_rate, max_steps)`: Adam training
- `train_robust(model, max_steps)`: Robust training (recommended)
- `step(step, learning_rate)`: Single step with clipping (recommended)
- `step_legacy(step, max_step_error_ratio)`: Old error-scaled step
- `is_converged(step, threshold)`: Check custom convergence threshold
- `check_polygon_validity(step)`: Detect self-intersecting polygons

### Server Protocol (`apvd-cli/src/server.rs`)

WebSocket at `ws://host:port/ws`:

**Client → Server:**
```json
{"type": "StartTraining", "shapes": [...], "targets": {...}, "max_steps": 1000}
{"type": "StopTraining"}
{"type": "Ping"}
```

**Server → Client:**
```json
{"type": "StepUpdate", "step_idx": 42, "error": 0.001, "shapes": [...], "converged": false}
{"type": "TrainingComplete", "total_steps": 100, "final_error": 1e-6}
{"type": "Error", "message": "..."}
{"type": "Pong"}
```

## Key Dependencies

- **num-dual**: Forward-mode automatic differentiation
- **nalgebra**: Linear algebra (vectors, matrices)
- **rayon**: Parallel scene training (CLI)
- **axum**: WebSocket server (CLI)
- **wasm-bindgen**: JS/WASM FFI
- **tsify**: TypeScript type generation

## Data Flow

1. Frontend/CLI passes shape specs + target sizes
2. Rust computes current region areas:
   - Find shape intersection points (quartic solver for ellipses)
   - Build boundary graph (edges, segments)
   - Compute signed area of each region
3. Autodiff computes error gradient w.r.t. shape parameters
4. Optimizer updates shapes to minimize area error
5. Repeat until converged or max steps reached

## Tests

```bash
cargo test -p apvd-core                    # All core tests
cargo test -p apvd-core fizz_buzz_bazz     # Specific test
RUST_LOG=debug cargo test -p apvd-core     # With logging
```

Test data in `apvd-core/testdata/` (CSV files with expected values).

## Known Issues

- Issue #9: Only absolute error metric (no relative)
- Issue #10: Basic missing-region penalty
- Quartic solver can have numerical stability issues at edge cases
- `Polygon::secant_area()` uses theta-from-centroid (atan2) to find intermediate
  vertices between two edge endpoints — breaks for concave polygons where angular
  ordering from centroid doesn't match perimeter ordering. Should use `perimeter_param`
  (edge_idx + t) instead, which is already used by `BoundaryCoord` for node ordering.
- `Segment::successors()` returns candidate edges without any ordering — region
  traversal picks edges arbitrarily, which can select wrong paths at intersection
  nodes on concave polygons.

## Future Improvements

### Algorithm Robustness
- **Fix `secant_area()` for concave polygons**: Replace theta-from-centroid vertex
  filtering with `perimeter_param`-based filtering (edge_idx + t ordering)
- **Order successors in region traversal**: Use `BoundaryCoord` to select the
  correct next edge at intersection nodes
- **Sweep line algorithm**: Replace current intersection logic with Bentley-Ottmann style
- **X-monotone decomposition**: Split curves at vertical tangent points

### Optimization
- **Loss function options**: Add stress metric, diagError metric (per eulerAPE/eulerr)

### Shape Support
- **Cubic Bezier curves**: Numerical intersection + Green's theorem for area
