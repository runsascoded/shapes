

use log::{info, debug};
use serde::{Deserialize, Serialize};
use tsify::Tsify;

use crate::{diagram::{Diagram, Targets}, shape::Input};

#[derive(Debug, Clone, Tsify, Serialize, Deserialize)]
pub struct Model {
    pub steps: Vec<Diagram>,
    pub repeat_idx: Option<usize>,
    pub min_idx: usize,
    pub min_error: f64,
}

impl Model {
    pub fn new(inputs: Vec<Input>, targets: Targets) -> Model {
        let diagram = Diagram::new(inputs, targets, None);
        let min_error = (&diagram).error.re.clone();
        let mut steps = Vec::<Diagram>::new();
        steps.push(diagram);
        let repeat_idx: Option<usize> = None;
        Model { steps, min_idx: 0, repeat_idx, min_error }
    }
    pub fn train(&mut self, max_step_error_ratio: f64, max_steps: usize) {
        let num_steps = self.steps.len().clone();
        let mut diagram = self.steps[num_steps - 1].clone();
        for idx in 0..max_steps {
            let step_idx = idx + num_steps;
            debug!("Step {}:", step_idx);
            let nxt = diagram.step(max_step_error_ratio);
            let nxt_err = nxt.error.re;
            let min_step = &self.steps[self.min_idx];
            if nxt_err < min_step.error.re {
                self.min_idx = step_idx;
                self.min_error = nxt_err;
            }
            self.steps.push(nxt.clone());

            // Check whether the newest step (`nxt`) is a repeat of a previous step:
            for (prv_idx, prv) in self.steps.iter().enumerate().rev().skip(1) {
                let prv_err = prv.error.re;
                if prv_err == nxt_err &&
                    prv
                    .shapes()
                    .iter()
                    .zip(nxt.shapes().iter())
                    .all(|(a, b)| {
                        //println!("Checking {} vs {}", a, b);
                        a == b
                    })
                {
                    info!("  Step {} matches step {}: {}", step_idx, prv_idx, prv_err);
                    self.repeat_idx = Some(prv_idx);
                    break;
                }
            }
            // If so, break
            if self.repeat_idx.is_some() {
                break;
            }
            diagram = nxt;
        }
    }
    pub fn grad_size(&self) -> usize {
        self.steps[0].grad_size()
    }
}

#[cfg(test)]
mod tests {
    use std::{env, collections::HashMap};

    use crate::{dual::Dual, circle::Circle, fmt::Fmt, r2::R2, shape::Shape, ellipses::xyrr::XYRR};

    use super::*;
    use test_log::test;

    pub struct ExpectedStep {
        vals: Vec<f64>,
        err: f64,
        grads: Vec<f64>,
    }
    impl ExpectedStep {
        pub fn dual(&self) -> Dual {
            Dual::new(self.err, self.grads.clone())
        }
    }
    impl<const N: usize> From<([f64; N], f64, [f64; N])> for ExpectedStep {
        fn from((vals, err, grads): ([f64; N], f64, [f64; N])) -> Self {
            ExpectedStep { vals: vals.to_vec(), err, grads: grads.to_vec() }
        }
    }

    pub trait To<T1> {
        fn to(self) -> T1;
    }
    impl<T0, T1: From<T0>> To<Vec<T1>> for Vec<T0> {
        fn to(self: Self) -> Vec<T1> {
            self.into_iter().map(|x| x.into()).collect()
        }
    }

    fn get_actual(step: &Diagram, getters: &Vec<CoordGetter>) -> ExpectedStep {
        let error = step.error.clone();
        let err = error.v();
        let mut vals: Vec<f64> = Vec::new();
        let mut grads: Vec<f64> = Vec::new();
        getters.iter().enumerate().for_each(|(coord_idx, getter)| {
            let val: f64 = getter.0(step.clone());
            vals.push(val);
            let error_d = error.d();
            let err_grad = error_d[coord_idx];
            grads.push(-err_grad);
        });
        ExpectedStep { vals, err, grads }
    }

    fn print_step(diagram: &Diagram, idx: usize, getters: &Vec<CoordGetter>) {
        let actual = get_actual(diagram, getters);
        let vals_str = actual.vals.iter().map(|g| g.s(3)).collect::<Vec<_>>().join(",");
        let grads_str = actual.grads.iter().map(|g| g.s(3)).collect::<Vec<_>>().join(", ");

        let total_err = diagram.error.clone();
        let err = total_err.v();
        let err_str = if err < 0.001 {
            format!("{:.3e}", err)
        } else {
            format!("{:.5}", err)
        };
        println!("([{} ], {: <9}, [{} ]),  // Step {}", vals_str, err_str, grads_str, idx);
    }

    fn one_hot(idx: usize, size: usize) -> Vec<f64> {
        let mut v = vec![0.; size];
        v[idx] = 1.;
        v
    }

    fn is_one_hot(v: &Vec<f64>) -> Option<usize> {
        let mut idx = None;
        for (i, x) in v.iter().enumerate() {
            if *x == 1. {
                if idx.is_some() {
                    return None;
                }
                idx = Some(i);
            } else if *x != 0. {
                return None;
            }
        }
        idx
    }

    pub struct CoordGetter(pub Box<dyn Fn(Diagram) -> f64>);

    fn test(
        inputs: Vec<Input>,
        targets: Vec<(&str, f64)>,
        expecteds: Vec<ExpectedStep>,
        max_step_error_ratio: f64,
        max_steps: usize
    ) {
        let targets: HashMap<_, _> = targets.iter().map(|(k, v)| (k.to_string(), *v)).collect();
        let mut model = Model::new(inputs.clone(), targets);
        model.train(max_step_error_ratio, max_steps);

        let mut coord_getters: Vec<(usize, CoordGetter)> = inputs.iter().enumerate().flat_map(
            |(shape_idx, (shape, duals))| match shape {
                Shape::Circle(_) => {
                    let getters = [
                        |c: Circle<f64>| c.c.x,
                        |c: Circle<f64>| c.c.y,
                        |c: Circle<f64>| c.r,
                    ];
                    getters.into_iter().zip(duals).filter_map(|(getter, dual)| {
                        is_one_hot(dual).map(|grad_idx| (
                            grad_idx,
                            CoordGetter(
                                Box::new(move |step: Diagram| match step.shapes()[shape_idx] {
                                    Shape::Circle(c) => getter(c),
                                    _ => panic!("Expected Circle at idx {}", shape_idx),
                                })
                            )
                        )
                    )
                    }).collect::<Vec<_>>()
                },
                Shape::XYRR(_) => {
                    let getters = [
                        |e: XYRR<f64>| e.c.x,
                        |e: XYRR<f64>| e.c.y,
                        |e: XYRR<f64>| e.r.x,
                        |e: XYRR<f64>| e.r.y,
                    ];
                    getters.into_iter().zip(duals).filter_map(|(getter, dual)| {
                        is_one_hot(dual).map(|grad_idx| (
                            grad_idx,
                            CoordGetter(
                                Box::new(move |step: Diagram| match step.shapes()[shape_idx].clone() {
                                    Shape::XYRR(e) => getter(e),
                                    _ => panic!("Expected XYRR at idx {}", shape_idx),
                                })
                            )
                        )
                    )
                    }).collect::<Vec<_>>()
                },
        }).collect();
        coord_getters.sort_by(|(a, _), (b, _)| a.cmp(b));
        assert_eq!(model.grad_size(), coord_getters.len());
        let coord_getters: Vec<_> = coord_getters.into_iter().map(|(_, getter)| getter).collect();
        // println!("coord_getters: {:?}", coord_getters.iter().map(|(idx, _)| idx).collect::<Vec<_>>());

        let steps = model.steps;
        let generate_vals = env::var("GENERATE_VALS").map(|s| s.parse::<usize>().unwrap()).ok();
        match generate_vals {
            Some(_) => {
                for (idx, step) in steps.iter().enumerate() {
                    print_step(&step, idx, &coord_getters);
                }
            }
            None => {
                assert_eq!(steps.len(), expecteds.len());
                for (idx, (step, expected)) in steps.iter().zip(expecteds.iter()).enumerate() {
                    let actual = get_actual(step, &coord_getters);
                    assert_eq!(actual.vals.len(), expected.vals.len());
                    for (a_val, e_val) in actual.vals.iter().zip(expected.vals.iter()) {
                        assert_relative_eq!(a_val, e_val, epsilon = 1e-3);
                    }
                    assert_relative_eq!(actual.dual(), expected.dual(), epsilon = 1e-3);

                    // assert_relative_eq trivially false-positives when the provided "expected" value is larger than the "actual" value, because it checks |A - B| / max(A, B).
                    // TODO: factor out and use a better relative-equality macro.
                    let a_err = actual.err;
                    let e_err = expected.err;
                    let abs_err_diff = (e_err - a_err).abs();
                    let relative_err = abs_err_diff / e_err;
                    assert!(relative_err < 1e-3, "relative_err {} >= 1e-3: actual err {}, expected {}", relative_err, a_err, e_err);

                    print_step(&step, idx, &coord_getters);
                }
            }
        }
    }

    static FIZZ_BUZZ: [(&str, f64); 3] = [
        ("0*", 1. /  3.),  // Fizz (multiples of 3)
        ("*1", 1. /  5.),  // Buzz (multiples of 5)
        ("01", 1. / 15.),  // Fizz Buzz (multiples of both 3 and 5)
    ];

    #[test]
    fn fizz_buzz_circles() {
        // 2 Circles, only the 2nd circle's x and r can move:
        // - 1st circle is fixed unit circle at origin
        // - 2nd circle's center is fixed on x-axis (y=0)
        // This is the minimal degrees of freedom that can reach any target (relative) distribution between {"0*", "*1", and "01"} (1st circle size, 2nd circle size, intersection size).
        let inputs: Vec<Input> = vec![
            (Shape::Circle(Circle { idx: 0, c: R2 { x: 0., y: 0. }, r: 1. }), vec![ vec![0., 0.], vec![0., 0.], vec![0., 0.], ]),
            (Shape::Circle(Circle { idx: 1, c: R2 { x: 1., y: 0. }, r: 1. }), vec![ vec![1., 0.], vec![0., 0.], vec![0., 1.], ]),
        ];

        let os = env::consts::OS;
        let macos = vec![
            ([ 1.000, 1.000 ], 0.38587  , [ 0.426, -1.456 ]),  // Step 0
            ([ 1.087, 0.704 ], 0.10719  , [-0.228,  1.615 ]),  // Step 1
            ([ 1.075, 0.789 ], 0.03504  , [ 0.741, -0.551 ]),  // Step 2
            ([ 1.097, 0.772 ], 0.00966  , [ 0.448,  1.048 ]),  // Step 3
            ([ 1.100, 0.779 ], 0.01118  , [ 0.716, -0.544 ]),  // Step 4
            ([ 1.107, 0.774 ], 0.00336  , [ 0.443,  1.047 ]),  // Step 5
            ([ 1.108, 0.776 ], 0.00378  , [ 0.708, -0.541 ]),  // Step 6
            ([ 1.111, 0.774 ], 0.001167 , [ 0.441,  1.046 ]),  // Step 7
            ([ 1.111, 0.775 ], 0.001298 , [ 0.705, -0.540 ]),  // Step 8
            ([ 1.112, 0.774 ], 4.052e-4 , [ 0.440,  1.046 ]),  // Step 9
            ([ 1.112, 0.775 ], 4.491e-4 , [ 0.704, -0.540 ]),  // Step 10
            ([ 1.112, 0.775 ], 1.406e-4 , [ 0.440,  1.046 ]),  // Step 11
            ([ 1.112, 0.775 ], 1.557e-4 , [ 0.704, -0.540 ]),  // Step 12
            ([ 1.113, 0.775 ], 4.880e-5 , [ 0.440,  1.046 ]),  // Step 13
            ([ 1.113, 0.775 ], 5.400e-5 , [ 0.704, -0.540 ]),  // Step 14
            ([ 1.113, 0.775 ], 1.693e-5 , [ 0.440,  1.046 ]),  // Step 15
            ([ 1.113, 0.775 ], 1.874e-5 , [ 0.704, -0.540 ]),  // Step 16
            ([ 1.113, 0.775 ], 5.877e-6 , [ 0.440,  1.046 ]),  // Step 17
            ([ 1.113, 0.775 ], 6.501e-6 , [ 0.704, -0.540 ]),  // Step 18
            ([ 1.113, 0.775 ], 2.039e-6 , [ 0.440,  1.046 ]),  // Step 19
            ([ 1.113, 0.775 ], 2.256e-6 , [ 0.704, -0.540 ]),  // Step 20
            ([ 1.113, 0.775 ], 7.076e-7 , [ 0.440,  1.046 ]),  // Step 21
            ([ 1.113, 0.775 ], 7.828e-7 , [ 0.704, -0.540 ]),  // Step 22
            ([ 1.113, 0.775 ], 2.456e-7 , [ 0.440,  1.046 ]),  // Step 23
            ([ 1.113, 0.775 ], 2.716e-7 , [ 0.704, -0.540 ]),  // Step 24
            ([ 1.113, 0.775 ], 8.521e-8 , [ 0.440,  1.046 ]),  // Step 25
            ([ 1.113, 0.775 ], 9.427e-8 , [ 0.704, -0.540 ]),  // Step 26
            ([ 1.113, 0.775 ], 2.957e-8 , [ 0.440,  1.046 ]),  // Step 27
            ([ 1.113, 0.775 ], 3.271e-8 , [ 0.704, -0.540 ]),  // Step 28
            ([ 1.113, 0.775 ], 1.026e-8 , [ 0.440,  1.046 ]),  // Step 29
            ([ 1.113, 0.775 ], 1.135e-8 , [ 0.704, -0.540 ]),  // Step 30
            ([ 1.113, 0.775 ], 3.561e-9 , [ 0.440,  1.046 ]),  // Step 31
            ([ 1.113, 0.775 ], 3.939e-9 , [ 0.704, -0.540 ]),  // Step 32
            ([ 1.113, 0.775 ], 1.236e-9 , [ 0.440,  1.046 ]),  // Step 33
            ([ 1.113, 0.775 ], 1.367e-9 , [ 0.704, -0.540 ]),  // Step 34
            ([ 1.113, 0.775 ], 4.288e-10, [ 0.440,  1.046 ]),  // Step 35
            ([ 1.113, 0.775 ], 4.743e-10, [ 0.704, -0.540 ]),  // Step 36
            ([ 1.113, 0.775 ], 1.488e-10, [ 0.440,  1.046 ]),  // Step 37
            ([ 1.113, 0.775 ], 1.646e-10, [ 0.704, -0.540 ]),  // Step 38
            ([ 1.113, 0.775 ], 5.163e-11, [ 0.440,  1.046 ]),  // Step 39
            ([ 1.113, 0.775 ], 5.712e-11, [ 0.704, -0.540 ]),  // Step 40
            ([ 1.113, 0.775 ], 1.792e-11, [ 0.440,  1.046 ]),  // Step 41
            ([ 1.113, 0.775 ], 1.982e-11, [ 0.704, -0.540 ]),  // Step 42
            ([ 1.113, 0.775 ], 6.217e-12, [ 0.440,  1.046 ]),  // Step 43
            ([ 1.113, 0.775 ], 6.878e-12, [ 0.704, -0.540 ]),  // Step 44
            ([ 1.113, 0.775 ], 2.157e-12, [ 0.440,  1.046 ]),  // Step 45
            ([ 1.113, 0.775 ], 2.387e-12, [ 0.704, -0.540 ]),  // Step 46
            ([ 1.113, 0.775 ], 7.487e-13, [ 0.440,  1.046 ]),  // Step 47
            ([ 1.113, 0.775 ], 8.283e-13, [ 0.704, -0.540 ]),  // Step 48
            ([ 1.113, 0.775 ], 2.598e-13, [ 0.440,  1.046 ]),  // Step 49
            ([ 1.113, 0.775 ], 2.872e-13, [ 0.704, -0.540 ]),  // Step 50
            ([ 1.113, 0.775 ], 9.023e-14, [ 0.440,  1.046 ]),  // Step 51
            ([ 1.113, 0.775 ], 9.948e-14, [ 0.704, -0.540 ]),  // Step 52
            ([ 1.113, 0.775 ], 3.120e-14, [ 0.440,  1.046 ]),  // Step 53
            ([ 1.113, 0.775 ], 3.486e-14, [ 0.704, -0.540 ]),  // Step 54
            ([ 1.113, 0.775 ], 1.105e-14, [ 0.440,  1.046 ]),  // Step 55
            ([ 1.113, 0.775 ], 1.199e-14, [ 0.704, -0.540 ]),  // Step 56
            ([ 1.113, 0.775 ], 3.691e-15, [ 0.440,  1.046 ]),  // Step 57
            ([ 1.113, 0.775 ], 4.219e-15, [ 0.704, -0.540 ]),  // Step 58
            ([ 1.113, 0.775 ], 1.360e-15, [ 0.440,  1.046 ]),  // Step 59
            ([ 1.113, 0.775 ], 1.499e-15, [ 0.704, -0.540 ]),  // Step 60
            ([ 1.113, 0.775 ], 6.661e-16, [ 0.440,  1.046 ]),  // Step 61
            ([ 1.113, 0.775 ], 6.939e-16, [ 0.704, -0.540 ]),  // Step 62
            ([ 1.113, 0.775 ], 5.551e-17, [ 0.440,  1.046 ]),  // Step 63
            ([ 1.113, 0.775 ], 5.551e-17, [ 0.440,  1.046 ]),  // Step 64
        ];
        let mut linux = macos.clone();
        linux[53] = ([ 1.113, 0.775 ], 3.114e-14, [ 0.440,  1.046 ]);  // Step 53

        let expecteds = if os == "macos" { macos } else { linux };

        test(inputs, FIZZ_BUZZ.into(), expecteds.to(), 0.8, 100);
    }

    #[test]
    fn fizz_buzz_circle_ellipse() {
        let inputs: Vec<Input> = vec![
            (
                Shape::Circle(Circle { idx: 0, c: R2 { x: 0., y: 0. }, r: 1. }),
                vec![
                    vec![0.; 3],
                    vec![0.; 3],
                    vec![0.; 3],
                ]),
            (
                Shape::XYRR(XYRR { idx: 1, c: R2 { x: 1., y: 0. }, r: R2 { x: 1., y: 1. } }),
                vec![
                    one_hot(0, 3),
                    vec![0.; 3],
                    one_hot(1, 3),
                    one_hot(2, 3),
                ]),
        ];

        let expecteds: Vec<ExpectedStep> = vec![
            ([ 1.000, 1.000, 1.000 ], 0.38587  , [ 0.426, -0.675, -0.781 ]),  // Step 0
            ([ 1.118, 0.813, 0.784 ], 0.03856  , [ 0.275, -0.842, -0.736 ]),  // Step 1
            ([ 1.125, 0.791, 0.764 ], 0.00566  , [-0.431, -0.407, -0.637 ]),  // Step 2
            ([ 1.123, 0.789, 0.761 ], 0.002334 , [-0.692,  0.435,  0.106 ]),  // Step 3
            ([ 1.121, 0.790, 0.761 ], 0.001593 , [-0.433, -0.407, -0.637 ]),  // Step 4
            ([ 1.121, 0.789, 0.760 ], 7.121e-4 , [-0.694,  0.435,  0.107 ]),  // Step 5
            ([ 1.120, 0.789, 0.760 ], 4.439e-4 , [-0.434, -0.407, -0.637 ]),  // Step 6
            ([ 1.120, 0.789, 0.760 ], 2.187e-4 , [-0.694,  0.435,  0.108 ]),  // Step 7
            ([ 1.120, 0.789, 0.760 ], 1.225e-4 , [-0.434, -0.407, -0.637 ]),  // Step 8
            ([ 1.120, 0.789, 0.760 ], 6.783e-5 , [-0.695,  0.435,  0.108 ]),  // Step 9
            ([ 1.120, 0.789, 0.760 ], 3.337e-5 , [-0.434, -0.407, -0.637 ]),  // Step 10
            ([ 1.120, 0.789, 0.760 ], 2.127e-5 , [-0.695,  0.435,  0.108 ]),  // Step 11
            ([ 1.120, 0.789, 0.760 ], 8.940e-6 , [-0.434, -0.407, -0.637 ]),  // Step 12
            ([ 1.120, 0.789, 0.760 ], 6.746e-6 , [-0.695,  0.435,  0.108 ]),  // Step 13
            ([ 1.120, 0.789, 0.760 ], 2.338e-6 , [-0.434, -0.407, -0.637 ]),  // Step 14
            ([ 1.120, 0.789, 0.760 ], 2.165e-6 , [-0.695,  0.435,  0.108 ]),  // Step 15
            ([ 1.120, 0.789, 0.760 ], 7.335e-7 , [-0.695,  0.435,  0.108 ]),  // Step 16
            ([ 1.120, 0.789, 0.760 ], 5.502e-7 , [-0.434, -0.407, -0.637 ]),  // Step 17
            ([ 1.120, 0.789, 0.760 ], 2.203e-7 , [-0.695,  0.435,  0.108 ]),  // Step 18
            ([ 1.120, 0.789, 0.760 ], 1.545e-7 , [-0.434, -0.407, -0.637 ]),  // Step 19
            ([ 1.120, 0.789, 0.760 ], 6.668e-8 , [-0.695,  0.435,  0.108 ]),  // Step 20
            ([ 1.120, 0.789, 0.760 ], 4.311e-8 , [-0.434, -0.407, -0.637 ]),  // Step 21
            ([ 1.120, 0.789, 0.760 ], 2.038e-8 , [-0.695,  0.435,  0.108 ]),  // Step 22
            ([ 1.120, 0.789, 0.760 ], 1.193e-8 , [-0.434, -0.407, -0.637 ]),  // Step 23
            ([ 1.120, 0.789, 0.760 ], 6.290e-9 , [-0.695,  0.435,  0.108 ]),  // Step 24
            ([ 1.120, 0.789, 0.760 ], 3.268e-9 , [-0.434, -0.407, -0.637 ]),  // Step 25
            ([ 1.120, 0.789, 0.760 ], 1.963e-9 , [-0.695,  0.435,  0.108 ]),  // Step 26
            ([ 1.120, 0.789, 0.760 ], 8.820e-10, [-0.434, -0.407, -0.637 ]),  // Step 27
            ([ 1.120, 0.789, 0.760 ], 6.198e-10, [-0.695,  0.435,  0.108 ]),  // Step 28
            ([ 1.120, 0.789, 0.760 ], 2.332e-10, [-0.434, -0.407, -0.637 ]),  // Step 29
            ([ 1.120, 0.789, 0.760 ], 1.980e-10, [-0.695,  0.435,  0.108 ]),  // Step 30
            ([ 1.120, 0.789, 0.760 ], 6.707e-11, [-0.695,  0.435,  0.108 ]),  // Step 31
            ([ 1.120, 0.789, 0.760 ], 5.617e-11, [-0.434, -0.407, -0.637 ]),  // Step 32
            ([ 1.120, 0.789, 0.760 ], 1.984e-11, [-0.695,  0.435,  0.108 ]),  // Step 33
            ([ 1.120, 0.789, 0.760 ], 1.591e-11, [-0.434, -0.407, -0.637 ]),  // Step 34
            ([ 1.120, 0.789, 0.760 ], 5.903e-12, [-0.695,  0.435,  0.108 ]),  // Step 35
            ([ 1.120, 0.789, 0.760 ], 4.493e-12, [-0.434, -0.407, -0.637 ]),  // Step 36
            ([ 1.120, 0.789, 0.760 ], 1.769e-12, [-0.695,  0.435,  0.108 ]),  // Step 37
            ([ 1.120, 0.789, 0.760 ], 1.263e-12, [-0.434, -0.407, -0.637 ]),  // Step 38
            ([ 1.120, 0.789, 0.760 ], 5.346e-13, [-0.695,  0.435,  0.108 ]),  // Step 39
            ([ 1.120, 0.789, 0.760 ], 3.530e-13, [-0.434, -0.407, -0.637 ]),  // Step 40
            ([ 1.120, 0.789, 0.760 ], 1.630e-13, [-0.695,  0.435,  0.108 ]),  // Step 41
            ([ 1.120, 0.789, 0.760 ], 9.795e-14, [-0.434, -0.407, -0.637 ]),  // Step 42
            ([ 1.120, 0.789, 0.760 ], 5.004e-14, [-0.695,  0.435,  0.108 ]),  // Step 43
            ([ 1.120, 0.789, 0.760 ], 2.684e-14, [-0.434, -0.407, -0.637 ]),  // Step 44
            ([ 1.120, 0.789, 0.760 ], 1.560e-14, [-0.695,  0.435,  0.108 ]),  // Step 45
            ([ 1.120, 0.789, 0.760 ], 7.327e-15, [-0.434, -0.407, -0.637 ]),  // Step 46
            ([ 1.120, 0.789, 0.760 ], 4.774e-15, [-0.695,  0.435,  0.108 ]),  // Step 47
            ([ 1.120, 0.789, 0.760 ], 2.137e-15, [-0.434, -0.407, -0.637 ]),  // Step 48
            ([ 1.120, 0.789, 0.760 ], 1.693e-15, [-0.695,  0.435,  0.108 ]),  // Step 49
            ([ 1.120, 0.789, 0.760 ], 6.384e-16, [-0.695,  0.435,  0.108 ]),  // Step 50
            ([ 1.120, 0.789, 0.760 ], 2.498e-16, [-0.434, -0.407, -0.637 ]),  // Step 51
            ([ 1.120, 0.789, 0.760 ], 2.498e-16, [-0.695,  0.435,  0.108 ]),  // Step 52
            ([ 1.120, 0.789, 0.760 ], 1.943e-16, [-0.434, -0.407, -0.637 ]),  // Step 53
            ([ 1.120, 0.789, 0.760 ], 3.886e-16, [ 0.695, -0.435, -0.108 ]),  // Step 54
            ([ 1.120, 0.789, 0.760 ], 1.665e-16, [-0.261,  0.842,  0.745 ]),  // Step 55
            ([ 1.120, 0.789, 0.760 ], 2.498e-16, [-0.695,  0.435,  0.108 ]),  // Step 56
        ].to();

        test(inputs, FIZZ_BUZZ.into(), expecteds, 0.8, 100)
    }

    static FIZZ_BUZZ_BAZZ: [(&str, f64); 7] = [
        ( "0**", 35. ),  // 1 / 3
        ( "*1*", 21. ),  // 1 / 5
        ( "**2", 15. ),  // 1 / 7
        ( "01*",  7. ),  // 1 / 15
        ( "0*2",  5. ),  // 1 / 21
        ( "*12",  3. ),  // 1 / 35
        ( "012",  1. ),  // 1 / 105
    ];

    #[test]
    fn fizz_buzz_ellipses_diag() {
        let inputs: Vec<Input> = vec![
            (
                Shape::XYRR(XYRR { idx: 0, c: R2 { x: 1., y: 0. }, r: R2 { x: 1., y: 1. } }),
                vec![
                    one_hot(0, 7),
                    vec![0.; 7],
                    one_hot(1, 7),
                    one_hot(2, 7),
                ]
            ), (
                Shape::XYRR(XYRR { idx: 1, c: R2 { x: 0., y: 1. }, r: R2 { x: 1., y: 1. } }),
                vec![
                    one_hot(3, 7),
                    one_hot(4, 7),
                    one_hot(5, 7),
                    one_hot(6, 7),
                ]
            ),
        ];

        let expecteds: Vec<ExpectedStep> = vec![
            ([ 1.000, 1.000, 1.000, 0.000, 1.000, 1.000, 1.000 ], 0.32865  , [-0.193,  0.646,  0.646,  0.193, -0.193, -0.454, -0.454 ]),  // Step 0
            ([ 0.962, 1.128, 1.128, 0.038, 0.962, 0.910, 0.910 ], 0.06363  , [-0.246,  0.574,  0.584,  0.246, -0.256, -0.461, -0.453 ]),  // Step 1
            ([ 0.952, 1.150, 1.151, 0.048, 0.952, 0.892, 0.893 ], 0.01937  , [-0.408,  0.149,  0.171,  0.408, -0.429,  0.221,  0.237 ]),  // Step 2
            ([ 0.946, 1.153, 1.153, 0.054, 0.945, 0.896, 0.896 ], 0.00873  , [-0.257,  0.555,  0.571,  0.257, -0.273, -0.458, -0.447 ]),  // Step 3
            ([ 0.944, 1.156, 1.157, 0.056, 0.943, 0.893, 0.894 ], 0.00653  , [-0.413,  0.145,  0.171,  0.413, -0.438,  0.223,  0.241 ]),  // Step 4
            ([ 0.942, 1.156, 1.158, 0.058, 0.941, 0.895, 0.895 ], 0.00272  , [-0.415,  0.144,  0.171,  0.415, -0.441,  0.224,  0.242 ]),  // Step 5
            ([ 0.941, 1.157, 1.158, 0.059, 0.940, 0.895, 0.896 ], 0.001583 , [-0.156, -0.409, -0.398,  0.156, -0.166,  0.682,  0.688 ]),  // Step 6
            ([ 0.941, 1.156, 1.158, 0.059, 0.940, 0.896, 0.897 ], 7.510e-4 , [-0.416,  0.144,  0.172,  0.416, -0.443,  0.224,  0.242 ]),  // Step 7
            ([ 0.941, 1.157, 1.158, 0.059, 0.939, 0.896, 0.897 ], 3.108e-4 , [-0.416,  0.144,  0.172,  0.416, -0.443,  0.224,  0.242 ]),  // Step 8
            ([ 0.940, 1.157, 1.158, 0.060, 0.939, 0.896, 0.897 ], 1.795e-4 , [-0.260,  0.553,  0.570,  0.260, -0.277, -0.458, -0.446 ]),  // Step 9
            ([ 0.940, 1.157, 1.158, 0.060, 0.939, 0.896, 0.897 ], 9.424e-5 , [-0.416,  0.143,  0.172,  0.416, -0.443,  0.224,  0.242 ]),  // Step 10
            ([ 0.940, 1.157, 1.158, 0.060, 0.939, 0.896, 0.897 ], 3.899e-5 , [-0.416,  0.143,  0.172,  0.416, -0.443,  0.224,  0.242 ]),  // Step 11
            ([ 0.940, 1.157, 1.158, 0.060, 0.939, 0.896, 0.897 ], 1.611e-5 , [-0.416,  0.143,  0.172,  0.416, -0.443,  0.224,  0.242 ]),  // Step 12
            // TODO: the error on this step is seemingly nondeterministic, with a range of â‰ˆ1%. Debug!
            // ([ 0.940, 1.157, 1.158, 0.060, 0.939, 0.896, 0.897 ], 6.684e-6 , [-0.416,  0.143,  0.172,  0.416, -0.443,  0.224,  0.242 ]),  // Step 13

        ].to();

        test(inputs, FIZZ_BUZZ.into(), expecteds, 0.7, 12)
    }

    #[test]
    fn fizz_buzz_bazz_circle_ellipses() {
        let inputs: Vec<Input> = vec![
            (
                Shape::Circle(Circle { idx: 0, c: R2 { x: 0., y: 0. }, r: 1. }),
                vec![
                    vec![0.; 7],
                    vec![0.; 7],
                    vec![0.; 7],
                ]), (
                Shape::XYRR(XYRR { idx: 1, c: R2 { x: 1., y: 0. }, r: R2 { x: 1., y: 1. } }),
                vec![
                    one_hot(0, 7),
                    vec![0.; 7],
                    one_hot(1, 7),
                    one_hot(2, 7),
                ]), (
                Shape::XYRR(XYRR { idx: 2, c: R2 { x: 0., y: 1. }, r: R2 { x: 1., y: 1. } }),
                vec![
                    one_hot(3, 7),
                    one_hot(4, 7),
                    one_hot(5, 7),
                    one_hot(6, 7),
                ]
            ),
        ];

        let expecteds: Vec<ExpectedStep> = vec![
            ([ 1.000, 1.000, 1.000, 0.000, 1.000, 1.000, 1.000 ], 0.66841  , [ 0.790, -0.669, -0.420, -0.290,  0.790, -0.420, -0.670 ]),  // Step 0
            ([ 1.230, 0.805, 0.878,-0.084, 1.230, 0.878, 0.805 ], 0.69634  , [-2.540,  2.120,  1.554,  2.213, -2.397,  1.230,  0.815 ]),  // Step 1
            ([ 0.988, 1.007, 1.026, 0.126, 1.002, 0.995, 0.882 ], 0.63995  , [ 0.782, -0.676, -0.477, -0.208,  0.829, -0.383, -0.726 ]),  // Step 2
            ([ 1.201, 0.823, 0.896, 0.070, 1.228, 0.891, 0.685 ], 0.32697  , [-2.244,  1.665,  1.989,  1.843, -2.717,  1.165,  0.847 ]),  // Step 3
            ([ 1.098, 0.900, 0.987, 0.155, 1.102, 0.944, 0.724 ], 0.31078  , [ 0.366, -0.565, -0.286,  0.069,  0.325, -0.224, -0.522 ]),  // Step 4
            ([ 1.179, 0.775, 0.924, 0.170, 1.174, 0.895, 0.608 ], 0.23611  , [-0.486,  0.519,  0.267,  0.031, -0.468, -0.442, -0.409 ]),  // Step 5
            ([ 1.104, 0.854, 0.965, 0.175, 1.102, 0.827, 0.545 ], 0.27045  , [ 0.089, -0.761, -0.513,  0.063, -0.429,  0.328,  0.680 ]),  // Step 6
            ([ 1.117, 0.741, 0.889, 0.184, 1.038, 0.876, 0.647 ], 0.19586  , [-0.563,  0.640,  0.397,  0.154, -0.091, -0.498, -0.731 ]),  // Step 7
            ([ 1.058, 0.808, 0.930, 0.200, 1.029, 0.824, 0.570 ], 0.17088  , [ 0.242, -0.584, -0.300,  0.139,  0.143, -0.232, -0.440 ]),  // Step 8
            ([ 1.091, 0.729, 0.890, 0.219, 1.048, 0.792, 0.510 ], 0.14411  , [-0.550, -0.408, -0.469,  0.038, -0.530,  0.260,  0.602 ]),  // Step 9
            ([ 1.044, 0.694, 0.850, 0.222, 1.003, 0.814, 0.561 ], 0.10177  , [ 0.012,  0.225,  0.325,  0.145, -0.051, -0.447, -0.700 ]),  // Step 10
            ([ 1.045, 0.711, 0.875, 0.233, 0.999, 0.780, 0.508 ], 0.10127  , [ 0.036, -0.832, -0.527,  0.050, -0.538,  0.345,  0.705 ]),  // Step 11
            ([ 1.047, 0.668, 0.847, 0.236, 0.971, 0.798, 0.544 ], 0.09256  , [-0.260,  0.984,  0.744,  0.153,  0.248, -0.230, -0.465 ]),  // Step 12
            ([ 1.035, 0.714, 0.882, 0.243, 0.983, 0.787, 0.523 ], 0.09847  , [ 0.073, -0.777, -0.463,  0.154, -0.008,  0.268,  0.341 ]),  // Step 13
            ([ 1.040, 0.661, 0.850, 0.254, 0.982, 0.805, 0.546 ], 0.09255  , [ 0.384,  0.563,  0.656,  0.153,  0.317, -0.175, -0.400 ]),  // Step 14
            ([ 1.062, 0.694, 0.889, 0.263, 1.001, 0.795, 0.522 ], 0.07985  , [ 0.073, -0.785, -0.451,  0.145, -0.001,  0.258,  0.324 ]),  // Step 15
            ([ 1.066, 0.651, 0.864, 0.271, 1.001, 0.809, 0.540 ], 0.10338  , [-0.612,  0.641,  0.378,  0.145, -0.118, -0.486, -0.769 ]),  // Step 16
            ([ 1.033, 0.685, 0.885, 0.278, 0.994, 0.783, 0.499 ], 0.08860  , [ 0.420, -0.505, -0.156,  0.041, -0.191,  0.589,  1.017 ]),  // Step 17
            ([ 1.052, 0.663, 0.878, 0.280, 0.986, 0.810, 0.545 ], 0.08177  , [-0.647,  0.659,  0.398,  0.161, -0.148, -0.486, -0.755 ]),  // Step 18
            ([ 1.025, 0.690, 0.894, 0.287, 0.979, 0.789, 0.513 ], 0.08245  , [ 0.463, -0.448, -0.105,  0.156,  0.345,  0.502,  0.654 ]),  // Step 19
            ([ 1.049, 0.667, 0.889, 0.295, 0.997, 0.815, 0.547 ], 0.07594  , [-0.649,  0.660,  0.402,  0.161, -0.159, -0.485, -0.747 ]),  // Step 20
            ([ 1.024, 0.693, 0.904, 0.301, 0.991, 0.796, 0.518 ], 0.08313  , [ 0.067, -0.799, -0.432,  0.160, -0.035,  0.263,  0.363 ]),  // Step 21
            ([ 1.028, 0.648, 0.880, 0.310, 0.989, 0.811, 0.538 ], 0.07281  , [ 0.382,  0.582,  0.645,  0.162,  0.289, -0.181, -0.383 ]),  // Step 22
            ([ 1.045, 0.675, 0.910, 0.318, 1.003, 0.803, 0.521 ], 0.06938  , [ 0.008, -0.853, -0.465,  0.043, -0.572,  0.354,  0.725 ]),  // Step 23
            ([ 1.046, 0.645, 0.894, 0.320, 0.982, 0.815, 0.546 ], 0.07930  , [-0.660,  0.676,  0.402,  0.170, -0.167, -0.484, -0.747 ]),  // Step 24
            ([ 1.019, 0.672, 0.910, 0.326, 0.976, 0.796, 0.516 ], 0.06857  , [ 0.457, -0.453, -0.101,  0.166,  0.330,  0.496,  0.673 ]),  // Step 25
            ([ 1.039, 0.653, 0.906, 0.333, 0.990, 0.817, 0.545 ], 0.06374  , [-0.017,  0.246,  0.344,  0.170, -0.106, -0.433, -0.677 ]),  // Step 26
            ([ 1.038, 0.664, 0.922, 0.342, 0.985, 0.796, 0.512 ], 0.06338  , [-0.000, -0.869, -0.453,  0.042, -0.588,  0.364,  0.735 ]),  // Step 27
            ([ 1.038, 0.637, 0.908, 0.343, 0.966, 0.808, 0.535 ], 0.05911  , [-0.291,  1.051,  0.705,  0.177,  0.199, -0.239, -0.436 ]),  // Step 28
            ([ 1.029, 0.668, 0.928, 0.348, 0.972, 0.801, 0.523 ], 0.06114  , [ 0.046, -0.814, -0.404,  0.177, -0.057,  0.266,  0.376 ]),  // Step 29
            ([ 1.031, 0.634, 0.912, 0.355, 0.970, 0.812, 0.538 ], 0.05673  , [-0.294,  1.055,  0.703,  0.179,  0.192, -0.242, -0.431 ]),  // Step 30
            ([ 1.023, 0.664, 0.931, 0.360, 0.975, 0.805, 0.526 ], 0.05494  , [ 0.045, -0.817, -0.397,  0.177, -0.066,  0.265,  0.383 ]),  // Step 31
            ([ 1.025, 0.634, 0.917, 0.367, 0.973, 0.815, 0.540 ], 0.05473  , [ 0.370,  0.620,  0.640,  0.180,  0.262, -0.195, -0.364 ]),  // Step 32
            ([ 1.038, 0.655, 0.939, 0.373, 0.982, 0.808, 0.528 ], 0.04713  , [ 0.042, -0.820, -0.389,  0.176, -0.064,  0.262,  0.376 ]),  // Step 33
            ([ 1.039, 0.629, 0.927, 0.379, 0.980, 0.816, 0.540 ], 0.05713  , [-0.682,  0.696,  0.405,  0.177, -0.199, -0.479, -0.731 ]),  // Step 34
            ([ 1.019, 0.649, 0.938, 0.384, 0.974, 0.802, 0.519 ], 0.04622  , [ 0.448, -0.462, -0.094,  0.177,  0.309,  0.485,  0.690 ]),  // Step 35
            ([ 1.032, 0.636, 0.936, 0.389, 0.983, 0.816, 0.538 ], 0.04252  , [-0.691,  0.698,  0.410,  0.177, -0.212, -0.480, -0.724 ]),  // Step 36
            ([ 1.018, 0.650, 0.944, 0.393, 0.978, 0.806, 0.523 ], 0.04455  , [ 0.045, -0.831, -0.382,  0.177, -0.079,  0.259,  0.392 ]),  // Step 37
            ([ 1.019, 0.626, 0.933, 0.398, 0.976, 0.814, 0.535 ], 0.04276  , [ 0.371,  0.630,  0.634,  0.182,  0.247, -0.199, -0.355 ]),  // Step 38
            ([ 1.029, 0.643, 0.950, 0.403, 0.983, 0.808, 0.525 ], 0.03921  , [-0.015, -0.886, -0.415,  0.031, -0.613,  0.372,  0.750 ]),  // Step 39
            ([ 1.029, 0.626, 0.942, 0.404, 0.971, 0.816, 0.539 ], 0.03934  , [-0.702,  0.712,  0.412,  0.183, -0.220, -0.482, -0.723 ]),  // Step 40
            ([ 1.015, 0.640, 0.950, 0.407, 0.967, 0.806, 0.525 ], 0.03633  , [ 0.440, -0.463, -0.091,  0.186,  0.298,  0.485,  0.702 ]),  // Step 41
            ([ 1.025, 0.629, 0.948, 0.411, 0.974, 0.817, 0.541 ], 0.03626  , [-0.034,  0.269,  0.361,  0.183, -0.150, -0.437, -0.656 ]),  // Step 42
            ([ 1.024, 0.637, 0.958, 0.416, 0.969, 0.805, 0.524 ], 0.03286  , [ 0.036, -0.841, -0.369,  0.183, -0.087,  0.258,  0.393 ]),  // Step 43
            ([ 1.025, 0.618, 0.950, 0.420, 0.968, 0.811, 0.532 ], 0.03126  , [-0.310,  1.094,  0.682,  0.188,  0.160, -0.251, -0.413 ]),  // Step 44
            ([ 1.020, 0.635, 0.960, 0.423, 0.970, 0.807, 0.526 ], 0.02987  , [ 0.035, -0.843, -0.365,  0.183, -0.092,  0.258,  0.398 ]),  // Step 45
            ([ 1.021, 0.618, 0.953, 0.427, 0.968, 0.812, 0.534 ], 0.02994  , [ 0.365,  0.648,  0.629,  0.190,  0.233, -0.207, -0.348 ]),  // Step 46
            ([ 1.028, 0.631, 0.965, 0.431, 0.973, 0.808, 0.527 ], 0.02581  , [ 0.033, -0.844, -0.361,  0.183, -0.092,  0.257,  0.394 ]),  // Step 47
            ([ 1.028, 0.616, 0.959, 0.434, 0.971, 0.813, 0.534 ], 0.02841  , [-0.707,  0.720,  0.409,  0.182, -0.232, -0.480, -0.715 ]),  // Step 48
            ([ 1.019, 0.626, 0.965, 0.436, 0.968, 0.806, 0.524 ], 0.02528  , [ 0.437, -0.468, -0.088,  0.190,  0.289,  0.477,  0.705 ]),  // Step 49
            ([ 1.025, 0.619, 0.963, 0.439, 0.972, 0.814, 0.535 ], 0.02298  , [-0.710,  0.722,  0.412,  0.181, -0.238, -0.482, -0.711 ]),  // Step 50
            ([ 1.017, 0.627, 0.968, 0.441, 0.970, 0.808, 0.527 ], 0.02200  , [ 0.034, -0.850, -0.357,  0.183, -0.101,  0.255,  0.403 ]),  // Step 51
            ([ 1.018, 0.615, 0.963, 0.444, 0.968, 0.812, 0.533 ], 0.02363  , [ 0.364,  0.656,  0.627,  0.192,  0.224, -0.210, -0.342 ]),  // Step 52
            ([ 1.023, 0.625, 0.972, 0.447, 0.972, 0.809, 0.528 ], 0.02129  , [-0.024, -0.905, -0.392,  0.020, -0.629,  0.379,  0.757 ]),  // Step 53
            ([ 1.023, 0.615, 0.968, 0.447, 0.965, 0.813, 0.535 ], 0.01915  , [ 0.359,  0.660,  0.626,  0.194,  0.222, -0.212, -0.342 ]),  // Step 54
            ([ 1.028, 0.623, 0.976, 0.449, 0.968, 0.810, 0.531 ], 0.01738  , [ 0.028, -0.850, -0.352,  0.187, -0.101,  0.256,  0.400 ]),  // Step 55
            ([ 1.028, 0.613, 0.972, 0.452, 0.967, 0.813, 0.536 ], 0.02180  , [-0.714,  0.730,  0.410,  0.184, -0.242, -0.482, -0.708 ]),  // Step 56
            ([ 1.020, 0.621, 0.976, 0.454, 0.964, 0.808, 0.528 ], 0.01704  , [ 0.431, -0.469, -0.086,  0.195,  0.281,  0.476,  0.709 ]),  // Step 57
            ([ 1.025, 0.616, 0.975, 0.456, 0.967, 0.813, 0.536 ], 0.01542  , [-0.717,  0.731,  0.412,  0.184, -0.248, -0.483, -0.705 ]),  // Step 58
            ([ 1.019, 0.622, 0.978, 0.457, 0.965, 0.809, 0.530 ], 0.01622  , [ 0.201, -0.689, -0.236,  0.190,  0.058, -0.301, -0.455 ]),  // Step 59
            ([ 1.022, 0.614, 0.976, 0.459, 0.966, 0.806, 0.525 ], 0.01547  , [ 0.375, -0.527, -0.122,  0.025, -0.246,  0.602,  1.062 ]),  // Step 60
            ([ 1.025, 0.610, 0.975, 0.459, 0.964, 0.810, 0.533 ], 0.01745  , [-0.318,  1.119,  0.669,  0.193,  0.141, -0.259, -0.401 ]),  // Step 61
            ([ 1.022, 0.619, 0.980, 0.461, 0.965, 0.808, 0.530 ], 0.01408  , [ 0.028, -0.855, -0.347,  0.187, -0.108,  0.254,  0.405 ]),  // Step 62
            ([ 1.022, 0.611, 0.977, 0.463, 0.964, 0.810, 0.534 ], 0.01284  , [-0.321,  1.120,  0.670,  0.194,  0.137, -0.260, -0.399 ]),  // Step 63
            ([ 1.020, 0.618, 0.981, 0.464, 0.965, 0.809, 0.531 ], 0.01296  , [ 0.200, -0.690, -0.234,  0.191,  0.055, -0.303, -0.455 ]),  // Step 64
            ([ 1.022, 0.611, 0.979, 0.466, 0.966, 0.806, 0.527 ], 0.01238  , [ 0.373, -0.527, -0.121,  0.024, -0.247,  0.603,  1.062 ]),  // Step 65
            ([ 1.024, 0.608, 0.978, 0.466, 0.964, 0.810, 0.533 ], 0.01503  , [-0.319,  1.122,  0.667,  0.194,  0.138, -0.260, -0.398 ]),  // Step 66
            ([ 1.022, 0.616, 0.983, 0.467, 0.965, 0.808, 0.530 ], 0.01178  , [-0.029, -0.912, -0.382,  0.015, -0.635,  0.384,  0.759 ]),  // Step 67
            ([ 1.022, 0.611, 0.981, 0.467, 0.961, 0.810, 0.535 ], 0.01025  , [ 0.356,  0.671,  0.624,  0.198,  0.211, -0.218, -0.335 ]),  // Step 68
            ([ 1.024, 0.616, 0.985, 0.469, 0.963, 0.808, 0.532 ], 0.01111  , [ 0.197, -0.690, -0.232,  0.193,  0.055, -0.304, -0.454 ]),  // Step 69
            ([ 1.026, 0.610, 0.983, 0.470, 0.963, 0.806, 0.529 ], 0.01007  , [-0.309, -0.073, -0.075,  0.022, -0.324,  0.560,  0.999 ]),  // Step 70
            ([ 1.024, 0.610, 0.983, 0.470, 0.961, 0.809, 0.534 ], 0.01036  , [-0.323,  1.126,  0.668,  0.196,  0.133, -0.262, -0.396 ]),  // Step 71
            ([ 1.022, 0.615, 0.986, 0.471, 0.962, 0.808, 0.533 ], 0.01076  , [ 0.197, -0.691, -0.231,  0.193,  0.053, -0.305, -0.453 ]),  // Step 72
            ([ 1.024, 0.610, 0.984, 0.473, 0.962, 0.805, 0.529 ], 0.00941  , [-0.310, -0.072, -0.075,  0.021, -0.326,  0.561,  1.000 ]),  // Step 73
            ([ 1.022, 0.609, 0.984, 0.473, 0.961, 0.808, 0.534 ], 0.00865  , [-0.085,  0.152,  0.073,  0.203,  0.363, -0.130, -0.212 ]),  // Step 74
            ([ 1.021, 0.611, 0.985, 0.475, 0.965, 0.807, 0.532 ], 0.00750  , [ 0.541, -0.361, -0.010,  0.028, -0.085,  0.048,  0.202 ]),  // Step 75
            ([ 1.026, 0.608, 0.985, 0.476, 0.964, 0.807, 0.533 ], 0.00943  , [-0.777,  0.683,  0.372,  0.008, -0.777, -0.351, -0.348 ]),  // Step 76
            ([ 1.022, 0.611, 0.986, 0.476, 0.961, 0.806, 0.532 ], 0.00791  , [ 0.597, -0.305,  0.027,  0.205,  0.437, -0.086, -0.148 ]),  // Step 77
            ([ 1.026, 0.609, 0.986, 0.477, 0.964, 0.805, 0.531 ], 0.00899  , [-0.710, -0.461, -0.332,  0.010, -0.710,  0.341,  0.694 ]),  // Step 78
            ([ 1.023, 0.607, 0.985, 0.477, 0.960, 0.807, 0.534 ], 0.00873  , [-0.325,  1.131,  0.666,  0.197,  0.130, -0.264, -0.393 ]),  // Step 79
            ([ 1.021, 0.612, 0.988, 0.478, 0.961, 0.806, 0.532 ], 0.00800  , [ 0.597, -0.305,  0.027,  0.206,  0.435, -0.087, -0.147 ]),  // Step 80
            ([ 1.025, 0.610, 0.988, 0.479, 0.964, 0.805, 0.531 ], 0.00917  , [-0.710, -0.461, -0.331,  0.009, -0.710,  0.341,  0.694 ]),  // Step 81
            ([ 1.022, 0.608, 0.986, 0.479, 0.961, 0.807, 0.534 ], 0.00722  , [-0.086,  0.152,  0.072,  0.205,  0.360, -0.132, -0.209 ]),  // Step 82
            ([ 1.021, 0.609, 0.987, 0.481, 0.964, 0.805, 0.532 ], 0.00680  , [ 0.540, -0.361, -0.010,  0.028, -0.086,  0.048,  0.202 ]),  // Step 83
            ([ 1.025, 0.607, 0.987, 0.482, 0.963, 0.806, 0.534 ], 0.00780  , [-0.779,  0.685,  0.373,  0.006, -0.777, -0.351, -0.346 ]),  // Step 84
            ([ 1.022, 0.610, 0.988, 0.482, 0.961, 0.804, 0.533 ], 0.00619  , [ 0.596, -0.305,  0.027,  0.207,  0.434, -0.088, -0.147 ]),  // Step 85
            ([ 1.025, 0.608, 0.989, 0.483, 0.963, 0.804, 0.532 ], 0.00789  , [-0.312, -0.072, -0.075,  0.020, -0.326,  0.562,  0.997 ]),  // Step 86
            ([ 1.024, 0.608, 0.988, 0.483, 0.961, 0.806, 0.536 ], 0.00702  , [-0.267, -0.357, -0.439,  0.010,  0.322, -0.473, -0.736 ]),  // Step 87
            ([ 1.022, 0.606, 0.986, 0.483, 0.963, 0.804, 0.533 ], 0.00765  , [-0.381,  1.075,  0.628,  0.017, -0.393, -0.130, -0.042 ]),  // Step 88
            ([ 1.021, 0.610, 0.989, 0.483, 0.961, 0.804, 0.533 ], 0.00717  , [ 0.757, -0.479, -0.267, -0.154,  0.262, -0.072, -0.022 ]),  // Step 89
            ([ 1.025, 0.608, 0.987, 0.482, 0.963, 0.803, 0.533 ], 0.00694  , [-0.312, -0.072, -0.075,  0.020, -0.327,  0.563,  0.997 ]),  // Step 90
            ([ 1.024, 0.608, 0.987, 0.482, 0.961, 0.806, 0.537 ], 0.00700  , [-0.325,  1.131,  0.665,  0.198,  0.127, -0.266, -0.390 ]),  // Step 91
            ([ 1.022, 0.611, 0.989, 0.483, 0.962, 0.805, 0.535 ], 0.00776  , [ 0.414, -0.812, -0.486,  0.013,  0.398, -0.428, -0.674 ]),  // Step 92
            ([ 1.024, 0.608, 0.987, 0.483, 0.963, 0.803, 0.533 ], 0.00727  , [-0.312, -0.072, -0.075,  0.020, -0.326,  0.563,  0.997 ]),  // Step 93
            ([ 1.023, 0.608, 0.987, 0.483, 0.962, 0.805, 0.537 ], 0.00636  , [-0.086,  0.152,  0.071,  0.205,  0.357, -0.132, -0.208 ]),  // Step 94
            ([ 1.022, 0.609, 0.988, 0.485, 0.965, 0.804, 0.535 ], 0.00662  , [-0.540, -0.293, -0.219,  0.012, -0.547, -0.220, -0.162 ]),  // Step 95
            ([ 1.019, 0.608, 0.987, 0.485, 0.962, 0.803, 0.534 ], 0.00666  , [ 0.540, -0.361, -0.010,  0.028, -0.088,  0.048,  0.204 ]),  // Step 96
            ([ 1.023, 0.605, 0.987, 0.485, 0.962, 0.803, 0.536 ], 0.00822  , [-0.324,  1.132,  0.664,  0.198,  0.127, -0.266, -0.389 ]),  // Step 97
            ([ 1.022, 0.610, 0.989, 0.486, 0.962, 0.802, 0.534 ], 0.00659  , [ 0.756, -0.479, -0.267, -0.154,  0.262, -0.072, -0.022 ]),  // Step 98
            ([ 1.025, 0.607, 0.988, 0.485, 0.963, 0.802, 0.534 ], 0.00694  , [-0.312, -0.072, -0.075,  0.020, -0.326,  0.564,  0.995 ]),  // Step 99
            ([ 1.024, 0.607, 0.988, 0.485, 0.962, 0.804, 0.538 ], 0.00708  , [-0.506,  0.623,  0.154,  0.003,  0.090, -0.608, -0.916 ]),  // Step 100
        ].to();

        test(inputs, FIZZ_BUZZ_BAZZ.into(), expecteds, 0.7, 100)
    }

    #[test]
    fn fizz_buzz_bazz_circles() {
        let inputs: Vec<Input> = vec![
            (
                Shape::Circle(Circle { idx: 0, c: R2 { x: 0., y: 0. }, r: 1. }),
                vec![
                    vec![0.; 5],
                    vec![0.; 5],
                    vec![0.; 5],
                ]), (
                Shape::Circle(Circle { idx: 1, c: R2 { x: 1., y: 0. }, r: 1. }),
                vec![
                    one_hot(0, 5),
                    vec![0.; 5],
                    one_hot(1, 5),
                ]), (
                Shape::Circle(Circle { idx: 2, c: R2 { x: 0., y: 1. }, r: 1. }),
                vec![
                    one_hot(2, 5),
                    one_hot(3, 5),
                    one_hot(4, 5),
                ]
            ),
        ];

        let expecteds: Vec<ExpectedStep> = vec![
            ([ 1.000, 1.000, 0.000, 1.000, 1.000 ], 0.66841  , [ 0.790, -1.090, -0.290,  0.790, -1.090 ]),  // Step 0
            ([ 1.192, 0.735,-0.070, 1.192, 0.735 ], 1.07256  , [-2.559,  3.674,  2.204, -2.436,  2.027 ]),  // Step 1
            ([ 0.867, 1.202, 0.209, 0.883, 0.993 ], 1.12399  , [ 0.849, -0.786, -0.228,  0.857, -0.947 ]),  // Step 2
            ([ 1.251, 0.846, 0.106, 1.270, 0.564 ], 1.22830  , [-2.356,  2.030,  1.990, -2.448,  3.585 ]),  // Step 3
            ([ 0.896, 1.152, 0.407, 0.901, 1.105 ], 1.18063  , [ 0.783, -0.870, -0.118,  0.939, -0.879 ]),  // Step 4
            ([ 1.267, 0.740, 0.351, 1.346, 0.688 ], 0.93121  , [-2.132,  3.353,  1.599, -2.823,  3.242 ]),  // Step 5
            ([ 1.038, 1.100, 0.522, 1.043, 1.036 ], 0.83157  , [ 0.746, -1.091, -0.014,  0.881, -1.056 ]),  // Step 6
            ([ 1.265, 0.767, 0.518, 1.312, 0.714 ], 0.41607  , [-1.824,  3.657,  1.387, -2.855,  2.038 ]),  // Step 7
            ([ 1.170, 0.959, 0.591, 1.162, 0.821 ], 0.30804  , [ 0.491, -1.247, -0.167,  0.191, -0.671 ]),  // Step 8
            ([ 1.240, 0.782, 0.567, 1.189, 0.725 ], 0.27646  , [-0.467,  0.861, -0.043, -0.461, -0.769 ]),  // Step 9
            ([ 1.172, 0.907, 0.561, 1.122, 0.613 ], 0.30465  , [ 0.085, -1.225, -0.004, -0.385,  0.979 ]),  // Step 10
            ([ 1.183, 0.746, 0.560, 1.072, 0.743 ], 0.23140  , [-0.539,  0.956, -0.045, -0.585, -0.725 ]),  // Step 11
            ([ 1.122, 0.853, 0.555, 1.006, 0.661 ], 0.14590  , [ 0.139, -1.392, -0.036, -0.321,  0.949 ]),  // Step 12
            ([ 1.130, 0.771, 0.553, 0.987, 0.717 ], 0.12730  , [-0.440,  0.955,  0.158, -0.026, -1.325 ]),  // Step 13
            ([ 1.107, 0.821, 0.561, 0.985, 0.648 ], 0.10840  , [ 0.133, -1.411, -0.047, -0.333,  0.947 ]),  // Step 14
            ([ 1.113, 0.759, 0.559, 0.971, 0.689 ], 0.09178  , [-0.457,  0.952,  0.153, -0.033, -1.328 ]),  // Step 15
            ([ 1.096, 0.795, 0.565, 0.970, 0.639 ], 0.07650  , [ 0.126, -1.424, -0.057, -0.343,  0.945 ]),  // Step 16
            ([ 1.100, 0.751, 0.563, 0.959, 0.668 ], 0.06380  , [-0.471,  0.950,  0.149, -0.038, -1.329 ]),  // Step 17
            ([ 1.087, 0.776, 0.567, 0.958, 0.633 ], 0.05241  , [ 0.122, -1.432, -0.064, -0.351,  0.944 ]),  // Step 18
            ([ 1.090, 0.746, 0.566, 0.951, 0.653 ], 0.04996  , [-0.141,  1.581,  0.209,  0.266, -0.790 ]),  // Step 19
            ([ 1.087, 0.777, 0.570, 0.956, 0.638 ], 0.04869  , [ 0.121, -1.431, -0.064, -0.354,  0.949 ]),  // Step 20
            ([ 1.090, 0.749, 0.569, 0.949, 0.656 ], 0.04763  , [-0.142,  1.583,  0.210,  0.265, -0.792 ]),  // Step 21
            ([ 1.087, 0.778, 0.573, 0.954, 0.642 ], 0.04668  , [ 0.120, -1.429, -0.064, -0.356,  0.953 ]),  // Step 22
            ([ 1.089, 0.752, 0.571, 0.947, 0.659 ], 0.04571  , [-0.142,  1.584,  0.212,  0.265, -0.793 ]),  // Step 23
            ([ 1.087, 0.780, 0.575, 0.952, 0.645 ], 0.04478  , [ 0.120, -1.428, -0.064, -0.358,  0.958 ]),  // Step 24
            ([ 1.089, 0.754, 0.574, 0.946, 0.662 ], 0.04567  , [-0.482,  0.961,  0.154, -0.045, -1.330 ]),  // Step 25
            ([ 1.080, 0.772, 0.577, 0.945, 0.637 ], 0.04538  , [ 0.262,  0.727, -0.045, -0.237,  1.163 ]),  // Step 26
            ([ 1.086, 0.789, 0.576, 0.939, 0.664 ], 0.04476  , [ 0.320, -1.056,  0.206,  0.198, -0.885 ]),  // Step 27
            ([ 1.093, 0.766, 0.580, 0.944, 0.644 ], 0.03945  , [-0.090,  0.079, -0.103, -0.543,  0.652 ]),  // Step 28
            ([ 1.090, 0.768, 0.577, 0.926, 0.665 ], 0.04194  , [ 0.109,  0.452,  0.176,  0.014, -1.219 ]),  // Step 29
            ([ 1.092, 0.778, 0.581, 0.927, 0.638 ], 0.04006  , [ 0.119, -1.438, -0.065, -0.359,  0.967 ]),  // Step 30
            ([ 1.094, 0.755, 0.580, 0.921, 0.653 ], 0.04084  , [-0.145,  1.599,  0.222,  0.262, -0.799 ]),  // Step 31
            ([ 1.092, 0.781, 0.583, 0.925, 0.641 ], 0.04035  , [ 0.119, -1.437, -0.065, -0.360,  0.971 ]),  // Step 32
            ([ 1.094, 0.758, 0.582, 0.919, 0.656 ], 0.03960  , [ 0.450,  1.080,  0.235,  0.323, -0.697 ]),  // Step 33
            ([ 1.102, 0.779, 0.587, 0.926, 0.643 ], 0.03526  , [ 0.115, -1.430, -0.065, -0.362,  0.968 ]),  // Step 34
            ([ 1.104, 0.759, 0.586, 0.921, 0.656 ], 0.03796  , [-0.145,  1.594,  0.223,  0.258, -0.796 ]),  // Step 35
            ([ 1.102, 0.782, 0.589, 0.924, 0.644 ], 0.03794  , [ 0.116, -1.430, -0.064, -0.361,  0.971 ]),  // Step 36
            ([ 1.104, 0.761, 0.588, 0.919, 0.659 ], 0.03906  , [-0.485,  0.962,  0.165, -0.051, -1.315 ]),  // Step 37
            ([ 1.096, 0.776, 0.591, 0.918, 0.638 ], 0.03589  , [ 0.466, -0.785, -0.011, -0.060,  1.470 ]),  // Step 38
            ([ 1.103, 0.765, 0.591, 0.917, 0.659 ], 0.03459  , [-0.488,  0.965,  0.167, -0.053, -1.313 ]),  // Step 39
            ([ 1.096, 0.778, 0.593, 0.917, 0.641 ], 0.03430  , [ 0.117, -1.436, -0.066, -0.363,  0.974 ]),  // Step 40
            ([ 1.097, 0.759, 0.592, 0.912, 0.654 ], 0.03596  , [-0.146,  1.602,  0.227,  0.257, -0.800 ]),  // Step 41
            ([ 1.095, 0.781, 0.595, 0.915, 0.643 ], 0.03591  , [ 0.168, -1.342,  0.189,  0.059,  0.485 ]),  // Step 42
            ([ 1.098, 0.758, 0.599, 0.916, 0.651 ], 0.03615  , [-0.292,  1.329,  0.200,  0.122,  0.594 ]),  // Step 43
            ([ 1.093, 0.780, 0.602, 0.918, 0.661 ], 0.03019  , [ 0.524, -1.415,  0.041,  0.553, -1.282 ]),  // Step 44
            ([ 1.099, 0.766, 0.602, 0.924, 0.648 ], 0.02908  , [ 0.252,  0.722, -0.047, -0.245,  1.180 ]),  // Step 45
            ([ 1.102, 0.776, 0.602, 0.920, 0.665 ], 0.03237  , [ 0.105,  0.458,  0.183,  0.004, -1.203 ]),  // Step 46
            ([ 1.104, 0.784, 0.605, 0.921, 0.644 ], 0.04015  , [ 0.117, -1.425, -0.064, -0.360,  0.973 ]),  // Step 47
            ([ 1.106, 0.761, 0.604, 0.915, 0.659 ], 0.03747  , [-0.484,  0.966,  0.169, -0.056, -1.310 ]),  // Step 48
            ([ 1.099, 0.776, 0.607, 0.914, 0.639 ], 0.03252  , [ 0.464, -0.784, -0.011, -0.061,  1.471 ]),  // Step 49
            ([ 1.105, 0.766, 0.606, 0.913, 0.659 ], 0.03090  , [-0.488,  0.968,  0.171, -0.059, -1.307 ]),  // Step 50
            ([ 1.098, 0.778, 0.609, 0.912, 0.642 ], 0.03155  , [ 0.116, -1.430, -0.067, -0.364,  0.976 ]),  // Step 51
            ([ 1.100, 0.760, 0.608, 0.908, 0.654 ], 0.03218  , [-0.147,  1.602,  0.231,  0.251, -0.796 ]),  // Step 52
            ([ 1.098, 0.780, 0.611, 0.911, 0.644 ], 0.03171  , [ 0.117, -1.430, -0.067, -0.365,  0.979 ]),  // Step 53
            ([ 1.100, 0.762, 0.610, 0.906, 0.657 ], 0.03095  , [-0.147,  1.603,  0.232,  0.251, -0.798 ]),  // Step 54
            ([ 1.098, 0.781, 0.612, 0.909, 0.647 ], 0.03043  , [ 0.166, -1.337,  0.194,  0.053,  0.491 ]),  // Step 55
            ([ 1.100, 0.761, 0.615, 0.910, 0.654 ], 0.02814  , [-0.148,  1.600,  0.231,  0.247, -0.793 ]),  // Step 56
            ([ 1.099, 0.779, 0.618, 0.913, 0.646 ], 0.02959  , [ 0.116, -1.425, -0.068, -0.365,  0.978 ]),  // Step 57
            ([ 1.100, 0.762, 0.617, 0.909, 0.657 ], 0.02938  , [-0.148,  1.601,  0.233,  0.248, -0.795 ]),  // Step 58
            ([ 1.098, 0.780, 0.620, 0.911, 0.648 ], 0.02874  , [ 0.116, -1.424, -0.068, -0.367,  0.981 ]),  // Step 59
            ([ 1.100, 0.764, 0.619, 0.907, 0.660 ], 0.02883  , [-0.488,  0.976,  0.174, -0.063, -1.309 ]),  // Step 60
            ([ 1.094, 0.775, 0.621, 0.906, 0.644 ], 0.02683  , [ 0.464, -0.788, -0.012, -0.063,  1.481 ]),  // Step 61
            ([ 1.099, 0.767, 0.621, 0.906, 0.660 ], 0.02921  , [ 0.316,  0.094,  0.012,  0.366, -1.596 ]),  // Step 62
            ([ 1.103, 0.768, 0.621, 0.910, 0.641 ], 0.03273  , [ 0.254,  0.733, -0.047, -0.242,  1.177 ]),  // Step 63
            ([ 1.107, 0.780, 0.620, 0.906, 0.659 ], 0.02593  , [ 0.522, -1.414,  0.045,  0.549, -1.283 ]),  // Step 64
            ([ 1.111, 0.767, 0.621, 0.911, 0.648 ], 0.02966  , [-0.685,  0.604, -0.118, -0.610,  0.578 ]),  // Step 65
            ([ 1.100, 0.777, 0.619, 0.901, 0.658 ], 0.02683  , [ 0.525, -1.422,  0.046,  0.553, -1.291 ]),  // Step 66
            ([ 1.105, 0.764, 0.619, 0.906, 0.646 ], 0.02949  , [-0.295,  1.336,  0.205,  0.113,  0.592 ]),  // Step 67
            ([ 1.101, 0.783, 0.622, 0.908, 0.654 ], 0.03116  , [ 0.376, -1.693,  0.022,  0.418,  0.101 ]),  // Step 68
            ([ 1.105, 0.762, 0.622, 0.913, 0.655 ], 0.02766  , [-0.487,  0.968,  0.171, -0.064, -1.302 ]),  // Step 69
            ([ 1.100, 0.773, 0.624, 0.912, 0.640 ], 0.03047  , [ 0.254,  0.735, -0.047, -0.243,  1.173 ]),  // Step 70
            ([ 1.104, 0.784, 0.623, 0.908, 0.658 ], 0.03154  , [ 0.376, -1.690,  0.022,  0.419,  0.103 ]),  // Step 71
            ([ 1.108, 0.763, 0.624, 0.914, 0.659 ], 0.03303  , [-0.484,  0.969,  0.172, -0.063, -1.302 ]),  // Step 72
            ([ 1.102, 0.776, 0.626, 0.913, 0.642 ], 0.03050  , [ 0.116, -1.422, -0.069, -0.363,  0.973 ]),  // Step 73
            ([ 1.103, 0.759, 0.625, 0.908, 0.653 ], 0.03021  , [-0.293,  1.330,  0.207,  0.113,  0.600 ]),  // Step 74
            ([ 1.099, 0.778, 0.628, 0.910, 0.662 ], 0.02924  , [ 0.315,  0.097,  0.015,  0.367, -1.591 ]),  // Step 75
            ([ 1.103, 0.779, 0.628, 0.914, 0.642 ], 0.03430  , [ 0.117, -1.420, -0.068, -0.362,  0.973 ]),  // Step 76
            ([ 1.104, 0.759, 0.627, 0.909, 0.655 ], 0.02982  , [-0.147,  1.596,  0.234,  0.244, -0.789 ]),  // Step 77
            ([ 1.103, 0.778, 0.630, 0.912, 0.646 ], 0.02816  , [ 0.115, -1.418, -0.068, -0.365,  0.976 ]),  // Step 78
            ([ 1.104, 0.762, 0.629, 0.908, 0.657 ], 0.02813  , [-0.487,  0.973,  0.173, -0.066, -1.303 ]),  // Step 79
            ([ 1.098, 0.773, 0.631, 0.907, 0.642 ], 0.02772  , [ 0.255,  0.736, -0.047, -0.244,  1.177 ]),  // Step 80
            ([ 1.102, 0.783, 0.631, 0.904, 0.658 ], 0.03271  , [ 0.525, -1.421,  0.049,  0.553, -1.283 ]),  // Step 81
            ([ 1.108, 0.767, 0.631, 0.910, 0.644 ], 0.03036  , [-0.344,  1.248, -0.060, -0.304,  1.078 ]),  // Step 82
            ([ 1.103, 0.783, 0.630, 0.907, 0.657 ], 0.03052  , [ 0.375, -1.691,  0.025,  0.419,  0.102 ]),  // Step 83
            ([ 1.108, 0.763, 0.631, 0.912, 0.659 ], 0.03099  , [-0.485,  0.971,  0.173, -0.066, -1.300 ]),  // Step 84
            ([ 1.102, 0.775, 0.633, 0.911, 0.642 ], 0.02845  , [-0.092,  0.098, -0.104, -0.545,  0.675 ]),  // Step 85
            ([ 1.100, 0.777, 0.631, 0.898, 0.657 ], 0.02725  , [ 0.524, -1.424,  0.050,  0.554, -1.292 ]),  // Step 86
            ([ 1.105, 0.764, 0.631, 0.904, 0.645 ], 0.02988  , [-0.344,  1.249, -0.061, -0.306,  1.086 ]),  // Step 87
            ([ 1.100, 0.779, 0.630, 0.900, 0.659 ], 0.03078  , [ 0.525, -1.423,  0.050,  0.555, -1.291 ]),  // Step 88
            ([ 1.106, 0.764, 0.631, 0.906, 0.645 ], 0.03073  , [-0.343,  1.248, -0.061, -0.305,  1.084 ]),  // Step 89
            ([ 1.102, 0.780, 0.630, 0.902, 0.659 ], 0.03042  , [ 0.524, -1.421,  0.050,  0.553, -1.288 ]),  // Step 90
            ([ 1.107, 0.765, 0.631, 0.907, 0.645 ], 0.03013  , [-0.343,  1.247, -0.060, -0.305,  1.083 ]),  // Step 91
            ([ 1.103, 0.781, 0.630, 0.904, 0.659 ], 0.02972  , [ 0.523, -1.419,  0.049,  0.552, -1.285 ]),  // Step 92
            ([ 1.108, 0.766, 0.630, 0.909, 0.646 ], 0.02942  , [-0.344,  1.246, -0.060, -0.305,  1.081 ]),  // Step 93
            ([ 1.104, 0.781, 0.630, 0.906, 0.659 ], 0.02902  , [ 0.522, -1.418,  0.049,  0.551, -1.283 ]),  // Step 94
            ([ 1.109, 0.767, 0.630, 0.911, 0.646 ], 0.03003  , [-0.685,  0.611, -0.119, -0.609,  0.576 ]),  // Step 95
            ([ 1.098, 0.778, 0.628, 0.901, 0.656 ], 0.02661  , [ 0.376, -1.697,  0.025,  0.421,  0.098 ]),  // Step 96
            ([ 1.101, 0.760, 0.628, 0.905, 0.657 ], 0.03034  , [-0.147,  1.600,  0.236,  0.245, -0.792 ]),  // Step 97
            ([ 1.100, 0.779, 0.631, 0.908, 0.648 ], 0.02899  , [ 0.322, -1.781, -0.240,  0.001,  0.588 ]),  // Step 98
            ([ 1.103, 0.760, 0.629, 0.908, 0.654 ], 0.02815  , [-0.293,  1.330,  0.207,  0.111,  0.601 ]),  // Step 99
            ([ 1.099, 0.777, 0.631, 0.909, 0.662 ], 0.02903  , [ 0.314,  0.097,  0.016,  0.367, -1.591 ]),  // Step 100
        ].to();

        test(inputs, FIZZ_BUZZ_BAZZ.into(), expecteds, 0.7, 100)
    }
}
